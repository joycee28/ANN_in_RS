// 1. Định nghĩa khu vực nghiên cứu (ROI - Region of Interest)
// Sử dụng một FeatureCollection có sẵn trên GEE hoặc tạo một hình chữ nhật bao quanh Côn Đảo.
// Để đơn giản, ta sẽ dùng tọa độ xấp xỉ bao quanh quần đảo Côn Đảo.

var conDao_coords = [
  [106.525, 8.60],
  [106.75, 8.60],
  [106.75, 8.78],
  [106.525, 8.78]
];

var roi = ee.Geometry.Polygon(conDao_coords);
Map.centerObject(roi, 11);
Map.addLayer(roi, {color: 'red'}, 'Khu vực Côn Đảo');

// 2. Định nghĩa Bộ sưu tập ảnh Sentinel-2 L2A và lọc theo tiêu chí
var S2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
    .filterBounds(roi)
    .filterDate('2019-01-01', '2023-12-31')
    .filterMetadata('CLOUDY_PIXEL_PERCENTAGE', 'less_than', 0.8); // Lọc mây dưới 0.8%

// Hàm Mask mây (tùy chọn nhưng nên có)
function maskS2clouds(image) {
  var qa = image.select('QA60');
  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
             .and(qa.bitwiseAnd(cirrusBitMask).eq(0));
  return image.updateMask(mask).divide(10000); // Chia 10000 để chuyển sang Reflectance
}

// 3. Áp dụng hàm mask và tạo ảnh Mosaic (lấy ảnh có giá trị pixel thấp nhất -> ít mây/bóng hơn)
var image = S2.map(maskS2clouds).median().clip(roi); // Sử dụng median để giảm nhiễu

// 4. Định nghĩa các dải (Bands) sẽ được sử dụng cho phân loại
// B2 (Blue), B3 (Green), B4 (Red), B8 (NIR - Cận Hồng ngoại) là cơ bản.
// Có thể thêm B5, B6, B7 (Red Edge) và B11, B12 (SWIR) để tăng độ chính xác.
var bands = ['B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B11', 'B12'];

// 5. Trực quan hóa ảnh Mosaic
var visualization = {
  min: 0.0,
  max: 0.3,
  bands: ['B4', 'B3', 'B2'], // Màu tự nhiên (Natural Color)
};

Map.addLayer(image, visualization, 'Ảnh Sentinel-2 Mosaic (2023)');

// 6. Hợp nhất và Gán Nhãn cho Dữ liệu Mẫu

// Ghi chú: Các biến đã được GEE tự động tạo dựa trên tên lớp bạn đặt:
// var vegetation = ee.FeatureCollection(geometry); 
// var water = ee.FeatureCollection(geometry_1);
// ... (tên biến có thể khác nhau tùy thứ tự bạn vẽ)

// 6.1. Gán thuộc tính 'class' (nhãn số) cho từng lớp
var vegetation_labeled = vegetation.map(function(feature) {
  return feature.set('label', 0); // Rừng tự nhiên = 0
});

var emptyland_labeled = emptyland.map(function(feature) {
  return feature.set('label', 1); // Đất trống/đồi trọc = 1
});

var urban_labeled = urban.map(function(feature) {
  return feature.set('label', 2); // Khu dân cư = 2
});

var water_labeled = water.map(function(feature) {
  return feature.set('label', 3); // Mặt nước = 3
});

var sand_labeled = sand.map(function(feature) {
  return feature.set('label', 4); // Cát/bãi biển = 4
});

// 6.2. Hợp nhất tất cả các lớp đã gán nhãn thành một FeatureCollection duy nhất
var training_data_merged = vegetation_labeled
    .merge(emptyland_labeled)
    .merge(urban_labeled)
    .merge(water_labeled)
    .merge(sand_labeled);

// Kiểm tra số lượng mẫu tổng thể (Không bắt buộc, nhưng nên làm)
print('Tổng số mẫu HUẤN LUYỆN (Training):', training_data_merged.size());

// 6.3. Gán thuộc tính 'label' cho từng lớp KIỂM TRA
var veg_val_labeled = vegetation_validation.map(function(feature) {
  return feature.set('label', 0);
});
var emp_val_labeled = emptyland_validation.map(function(feature) {
  return feature.set('label', 1);
});
var urb_val_labeled = urban_validation.map(function(feature) {
  return feature.set('label', 2);
});
var wat_val_labeled = water_validation.map(function(feature) {
  return feature.set('label', 3);
});
var san_val_labeled = sand_validation.map(function(feature) {
  return feature.set('label', 4);
});

// 6.4. Hợp nhất dữ liệu KIỂM TRA ĐỘC LẬP
var validation_data_merged = veg_val_labeled
    .merge(emp_val_labeled)
    .merge(urb_val_labeled)
    .merge(wat_val_labeled)
    .merge(san_val_labeled);
print('Tổng số mẫu KIỂM TRA ĐỘC LẬP (Validation):', validation_data_merged.size());

// 7. Lấy giá trị pixel (Training Samples) từ ảnh Mosaic tại các điểm mẫu
// 7.1. Trích xuất giá trị pixel cho HUẤN LUYỆN (TRAINING PIXELS)
var training_pixels = image.select(bands).sampleRegions({
  collection: training_data_merged, // FeatureCollection đã hợp nhất và gán nhãn
  properties: ['label'],            // Thuộc tính nhãn cần trích xuất 
  scale: 10,                        // Độ phân giải 10m
});

// 7.1. Trích xuất giá trị pixel cho KIỂM TRA (VALIDATION PIXELS)
var validation_pixels = image.select(bands).sampleRegions({
  collection: validation_data_merged, 
  properties: ['label'],             
  scale: 10,                        
});

// --- BƯỚC 8: XUẤT TẤT CẢ TÁC VỤ (TASKS) RA GOOGLE DRIVE ---

// 8.1. XUẤT BỘ 1: DỮ LIỆU PIXEL HUẤN LUYỆN (CHO COLAB) - CSV
Export.table.toDrive({
    collection: training_pixels,
    description: 'A1_TRAIN_DATA',
    folder: 'GEE_ANN_Exports',
    fileNamePrefix: 'con_dao_TRAINING',
    fileFormat: 'CSV'
});

// 8.2. XUẤT BỘ 2: DỮ LIỆU PIXEL KIỂM TRA ĐỘC LẬP (CHO COLAB) - CSV
Export.table.toDrive({
    collection: validation_pixels,
    description: 'A2_VALIDATION_DATA',
    folder: 'GEE_ANN_Exports',
    fileNamePrefix: 'con_dao_VALIDATION',
    fileFormat: 'CSV'
});

// 8.3. XUẤT BỘ 3: VÙNG MẪU HUẤN LUYỆN (CHO ENVI) - GeoJSON
// SỬ DỤNG training_data_merged (FeatureCollection Vector)
Export.table.toDrive({
    collection: training_data_merged, 
    description: 'C1_TRAINING_ROI_ENVI',
    folder: 'GEE_ANN_Exports',
    fileNamePrefix: 'con_dao_TRAINING_ROI',
    fileFormat: 'GeoJSON' // Định dạng xuất ROI cho ENVI
});

// 8.4. XUẤT BỘ 4: VÙNG MẪU KIỂM TRA (CHO ENVI) - GeoJSON
// SỬ DỤNG validation_data_merged (FeatureCollection Vector)
Export.table.toDrive({
    collection: validation_data_merged,
    description: 'C2_VALIDATION_ROI_ENVI',
    folder: 'GEE_ANN_Exports',
    fileNamePrefix: 'con_dao_VALIDATION_ROI',
    fileFormat: 'GeoJSON' // Định dạng xuất ROI cho ENVI
});

// 8.5. XUẤT BỘ 5: ẢNH MOSAIC GỐC (CHO ENVI) - GeoTIFF
Export.image.toDrive({
    image: image.select(bands).clip(roi),
    description: 'B_SENTINEL2_ENVI',
    folder: 'GEE_ANN_Exports',
    fileNamePrefix: 'con_dao_mosaic',
    scale: 10,
    maxPixels: 1e13,
    fileFormat: 'GeoTIFF'
});

// NHẮC NHỞ: Sau khi chạy code, bạn cần RUN cả 5 tác vụ (Tasks) trong tab Tasks!
